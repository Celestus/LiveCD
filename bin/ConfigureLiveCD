#!/bin/sh

#
# This script configures the enviroment to run the Live-CD.
#

# Changelog:
# 
# 13/05/2005 - [detsch]  - de_DE on .kde
# 22/02/2005 - [lucasvr] - First version, splitted from the 'Start' script
#

source GoboPath
source StartFunctions

######################################
# Hotplug
######################################
if [ -d ${goboPrograms}/Hotplug ]
then
	msg_no_nl "Starting Hotplug (<esc> to skip)" 
	skip_on_esc 3 && echo && ${goboPrograms}/BootScripts/Current/bin/StartTask Hotplug 2>/dev/null || echo '<SKIPPED>'
fi

######################################
# X11
######################################
if [ -d ${goboPrograms}/Xorg ]
then
	msg_no_nl "Starting X11 detection (<esc> to skip)" 
	skip_on_esc 3 && echo && { 
	   GenXorgConf > /tmp/xorg.conf && mv /tmp/xorg.conf ${goboPrograms}/Xorg/Settings/X11/xorg.conf || echo FAILED
	} || echo '<SKIPPED>'
fi

######################################
# Choose language
######################################
mkdir ${goboTemp}/setup

dialog --title "Language"  --menu "Choose your language"  10 46 3  \
     "en_US" "English"    \
     "pt_BR" "Português"  \
     "de_DE" "Deutsch" 2> ${goboTemp}/setup/language

language=`cat ${goboTemp}/setup/language`
if [ "$language" = "" ]
then
   language=$LANG
fi

export LANG=${language}
export LC_ALL="$LANG"

echo "export LANG=${LANG}"   >> ${goboUsers}/gobo/.zshrc
echo "export LANG=${LANG}"   >> ${goboUsers}/gobo/.bashrc
echo "export LC_ALL=${LANG}" >> ${goboUsers}/gobo/.zshrc
echo "export LC_ALL=${LANG}" >> ${goboUsers}/gobo/.bashrc


######################################
# Adjusting .kde to the chosen lang
######################################
if [ "$LANG" == "pt_BR" -a -d ${goboPrograms}/KDE ]
then
    echo "[Locale]" >> ${goboUsers}/gobo/.kde/share/config/kdeglobals
    echo "Country=br" >> ${goboUsers}/gobo/.kde/share/config/kdeglobals
    echo "Language=pt_BR" >> ${goboUsers}/gobo/.kde/share/config/kdeglobals

    eskeldir=${goboShared}/EnhancedSkel/Default/
    turn_temporary ${eskeldir}/.kde/share/config/
    
    echo "[Locale]" >> ${eskeldir}/.kde/share/config/kdeglobals
    echo "Country=br" >> ${eskeldir}/.kde/share/config/kdeglobals
    echo "Language=pt_BR" >> ${eskeldir}/.kde/share/config/kdeglobals
fi

if [ "$LANG" == "de_DE" -a -d ${goboPrograms}/KDE ]
then
    echo "[Locale]" >> ${goboUsers}/gobo/.kde/share/config/kdeglobals
    echo "Country=de" >> ${goboUsers}/gobo/.kde/share/config/kdeglobals
    echo "Language=de" >> ${goboUsers}/gobo/.kde/share/config/kdeglobals

    eskeldir=${goboShared}/EnhancedSkel/Default/
    turn_temporary ${eskeldir}/.kde/share/config/
    
    echo "[Locale]" >> ${eskeldir}/.kde/share/config/kdeglobals
    echo "Country=de" >> ${eskeldir}/.kde/share/config/kdeglobals
    echo "Language=de" >> ${eskeldir}/.kde/share/config/kdeglobals
fi


######################################
# Choose keymap
######################################
[ -d ${goboTemp}/setup ] || mkdir ${goboTemp}/setup
KeymapDialog ${LANG} 2> ${goboTemp}/setup/keymap
MAPNAME="`cat ${goboTemp}/setup/keymap`"
MAPNAME="`basename $MAPNAME`"
basename $MAPNAME .map  > ${goboTemp}/setup/keymap
msg "Loading selected Keymap"
loadkeys $MAPNAME

######################################
# Adjusting xorg.conf
######################################
if [ -d ${goboPrograms}/Xorg ]
then
	msg "Adjusting xorg.conf"
	cat ${goboPrograms}/Xorg/Settings/X11/xorg.conf | ModifyXorgConf `cat ${goboTemp}/setup/keymap` > /tmp/xorg.conf.$$ 
	cp -f /tmp/xorg.conf.$$ ${goboPrograms}/Xorg/Settings/X11/xorg.conf
fi

