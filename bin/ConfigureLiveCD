#!/bin/sh

source GoboPath
source StartFunctions

if `cat ${goboStatus}/ide/*/model | grep -qi qemu`
then platform=emulated
else platform=native
fi

######################################
# X11
######################################
if [ -d ${goboPrograms}/Xorg -a "$platform" = "native" ]
then
	msg_no_nl "Starting X11 detection (<esc> to skip)" 
	skip_on_esc 3 && echo && { 
	   GenXorgConf > /tmp/xorg.conf && mv /tmp/xorg.conf ${goboPrograms}/Xorg/Settings/X11/xorg.conf || echo FAILED
	} || echo '<SKIPPED>'
fi

######################################
# Choose language
######################################
mkdir ${goboTemp}/setup

dialog --title "Language"  --menu "Choose your language"  10 46 3  \
     "en_US" "English"    \
     "pt_BR" "Português"  \
     "de_DE" "Deutsch" 2> ${goboTemp}/setup/language

language=`cat ${goboTemp}/setup/language`
if [ "$language" = "" ]
then
   echo en_US > ${goboTemp}/setup/language
   language=en_US
fi

export LANG=${language}
export LC_ALL="$LANG"

cat <<EOF | tee -a $HOME/.zshrc > $HOME/.bashrc
export LANG=${LANG}
export LC_ALL=${LANG}
EOF

######################################
# Adjusting .kde to the chosen lang
######################################

if [ -d "${goboPrograms}/KDE" ]
then
   case "$LANG" in
   pt_BR) kdecountry=br; kdelanguage=pt_BR ;;
   de_DE) kdecountry=de; kdelanguage=de ;;
   esac
   if [ "$kdecountry" ]
   then
      eskeldir=${goboPrograms}/EnhancedSkel/Current/testuser/
cat <<EOF | tee -a $HOME/.kde/share/config/kdeglobals > ${eskeldir}/.kde/share/config/kdeglobals
[Locale]
Country=$kdecountry
Language=$kdelanguage
EOF
   fi
fi

######################################
# Choose keymap
######################################
[ -d ${goboTemp}/setup ] || mkdir ${goboTemp}/setup
KeymapDialog ${LANG} 2> ${goboTemp}/setup/keymap
clear
MAPNAME="`tail -n 1 ${goboTemp}/setup/keymap`"
MAPNAME="`basename $MAPNAME`"
basename $MAPNAME .map  > ${goboTemp}/setup/keymap
msg "Loading selected Keymap"
loadkeys $MAPNAME

######################################
# Adjusting xorg.conf
######################################
if [ -d ${goboPrograms}/Xorg -a -f ${goboPrograms}/Xorg/Settings/X11/xorg.conf ]
then
	msg "Adjusting xorg.conf"
	cat ${goboPrograms}/Xorg/Settings/X11/xorg.conf | ModifyXorgConf `cat ${goboTemp}/setup/keymap` > /tmp/xorg.conf.$$ 
	cp -f /tmp/xorg.conf.$$ ${goboPrograms}/Xorg/Settings/X11/xorg.conf
fi
