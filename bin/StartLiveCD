#!/bin/sh

source GoboPath
source StartFunctions

export LANG=en_US

######################################
# start the udev daemon
######################################
msg "Starting Udev"
/System/Links/Tasks/Udev

######################################
# change console font
######################################
msg "Setting console font"
setfont /Files/Fonts/Console/lode-lat1u-16.psf.gz

######################################
# launch the loopback interface
######################################
msg "Launching the loopback interface"
ifconfig lo 127.0.0.1

######################################
# mount extra partitions
######################################
for i in `fdisk -l | grep "Linux swap" | cut -d" " -f1`
do 
  msg "Enabling swap on $i"
  swapon "$i"
done

######################################
# Initialize Users directory
######################################
msg "Initializing home directory"
export HOME=${goboUsers}/gobo
rm -rf ${goboUsers}
mkdir -p ${goboUsers}
cp -a ${goboPrograms}/EnhancedSkel/Current/testuser $HOME || mkdir -p $HOME

cp -a ${goboPrograms}/LiveCD/Current/Data/Users_gobo/Desktop/* $HOME/Desktop
cp -a ${goboPrograms}/LiveCD/Current/Data/Users_gobo/.zshrc    $HOME

cd $HOME
GrepReplace -R "/Users/testuser" $HOME
cd - &> /dev/null

rm -f $HOME/Desktop/Manager.desktop

######################################
# Hostname => "LiveCD"
######################################
msg "Setting hostname"
hostname LiveCD

########################################
# GoboHide - little trick due to unionfs
########################################
msg "Hiding legacy directories"
for i in bin dev etc lib proc sbin sys tmp usr var
do
    gobohide -h /Mount/.Pivot/Mount/SquashFS/Rest/$i
done

######################################
# Launch the configuration script
######################################
ConfigureLiveCD
LANG=`cat ${goboTemp}/setup/language`

######################################
# DHCP
######################################
# Executes the 'launch_dhcp' function if an ethernet interface was found
ifconfig eth0 2> /dev/null && { msg "Starting dhcp client"; launch_dhcp; }

######################################
# Mount remaining filesystems
######################################
mount -a -t tmpfs,devpts,usbfs

######################################
# Configure date and time
######################################
msg "Configuring date and time"
hwclock --hctosys

######################################
# Welcome message
######################################
clear
cat ${goboPrograms}/LiveCD/Current/Data/Language/Welcome_${LANG}

######################################
# Fix the multi-user console
######################################
inittablnk=`readlink -f ${goboSettings}/inittab`
ln -nfs ${goboPrograms}/LiveCD/Current/Resources/Defaults/Settings/inittab ${goboSettings}/inittab
init q
ln -nfs $inittablnk ${goboSettings}/inittab
