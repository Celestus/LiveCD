#!/bin/sh

#
# This script configures the enviroment to run the Live-CD.
#

# Changelog:
#
# [some time ago] - Guilherme Balestieri Bedin (gbedin)
#       - First version
#
# [05/10/2003] - Guilherme Balestieri Bedin (gbedin)
#       - Add support to /var/log on the tmpfs
#       - Add supoort to <Application>/Settings on the tmpfs
#
# [10/11/2003] - Guilherme Balestieri Bedin (gbedin)
#       - Some coments
#       - Add choose language 
#       - Add choose keymap
#       - Add hardware detection
#       - Automatic XFree86 configuration
#
# [08/11/2003] - detsch
#       - lot of small changes 
#
# [02/09/2004] - detsch
#       - /Mount/TmpFS -> /TmpFS. turn_temporary(/Mount)
#
# [19/01/2005] - detsch
#       - no more devfs (now using udev)
# 
# [19/02/2005] - lucasvr
#       - removed kudzu/hardware detection calls: we're now using hotplug
#       - major cleanup on the script: splitted into Start,StartFunctions 
#         and StartDialog
#

source GoboPath
source StartFunctions

export LANG=en_US

######################################
# start the udev daemon
######################################
msg "Starting Udev"
/System/Links/Tasks/Udev
/System/Links/Tasks/Coldplug

######################################
# change console font
######################################
msg "Setting console font"
setfont ${goboSettings}/kbd/consolefonts/lode-lat1u-16.psf.gz

######################################
# launch the loopback interface
######################################
msg "Launching the loopback interface"
ifconfig lo 127.0.0.1

######################################
# mount extra partitions
######################################
#msg "Enabling TmpFS"
#mount -t tmpfs -o size=16m tmpfs ${tmpfsdir}

for i in `fdisk -l | grep "Linux swap" | cut -d" " -f1`
do 
  msg "Enabling swap on $i"
  swapon "$i"
done

######################################
# Initialize Users directory (tmpfs)
######################################
msg "Initializing home directory"
#turn_temporary ${goboUsers}
export HOME=${goboUsers}/gobo
rm -rf $HOME
cp -a ${goboPrograms}/EnhancedSkel/Current/Shared/EnhancedSkel/Default/* $HOME

cp -a ${goboPrograms}/LiveCD/Current/Data/Users_gobo/Desktop/* $HOME/Desktop
cp -a ${goboPrograms}/LiveCD/Current/Data/Users_gobo/.zshrc    $HOME

cd $HOME
GrepReplace -R "/Users/testuser" $HOME
cd - &> /dev/null

rm -f $HOME/Desktop/Manager.desktop


######################################
# Overall TmpFS
######################################
msg "Activating TmpFS on some directories"
# Initialize System/Variable directory (tmpfs)
#turn_temporary ${goboVariable}

## Initialize some Programs settings directories on the tmpfs
#for prog in Xorg BootScripts RP-PPPoE
#do
#   turn_temporary ${goboPrograms}/${prog}/Settings
#done

## Initialize some Programs variable directories on the tmpfs
#for prog in Hotplug
#do
#   turn_temporary ${goboPrograms}/${prog}/Variable
#done

## Initialize System/Settings directory on the tmpfs
#for entry in "${goboSettings}" "/Mount" "/Programs/LiveCD" "/Programs/Installer"
#do
#  turn_temporary $entry
#done

######################################
# Hostname => "LiveCD"
######################################
msg "Setting hostname"
hostname LiveCD

######################################
# GoboHide
######################################
msg "Hiding legacy directories"
${goboPrograms}/BootScripts/Current/bin/StartTask GoboHide
#gobohide -h /TmpFS

######################################
# Launch the configuration script
######################################
ConfigureLiveCD
LANG=`cat ${goboTemp}/setup/language`

######################################
# DHCP
######################################
# Executes the 'launch_dhcp' function if an ethernet interface was found
ifconfig eth0 2> /dev/null && { msg "Starting dhcp client"; launch_dhcp; }

######################################
# Welcome message
######################################
clear
cat ${goboPrograms}/LiveCD/Current/Data/Language/Welcome_${LANG}
zsh

